<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Классный журнал</title>
    <style>
        body { font-family: Arial; margin: 0; padding: 20px; background: #f5f5f5; }
        .journal-page { 
            width: 1400px; margin: 20px auto; 
            border: 1px solid #ccc; padding: 20px;
            background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .class-navigation { 
            text-align: center; margin: 20px 0; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .students-table { 
            width: 100%; border-collapse: collapse; 
            font-size: 14px;
        }
        .students-table th, .students-table td { 
            border: 1px solid #ddd; padding: 8px; text-align: center; 
        }
        .mark-cell { 
            width: 40px; height: 40px; cursor: pointer; 
            background: #f9f9f9; font-weight: bold;
            vertical-align: middle;
            position: relative;
        }
        .mark-cell:hover { background: #e3f2fd; }
        .mark-cell.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid #ccc;
            border-top: 2px solid #3f51b5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .student-name { 
            text-align: left; width: 200px; padding-left: 15px !important;
            font-weight: bold;
        }
        .class-header { 
            background: #3f51b5; color: white; padding: 15px 30px;
            font-size: 20px; border-radius: 5px;
        }
        .date-header { 
            background: #f5f5f5; font-size: 12px; font-weight: bold;
            padding: 10px 5px;
        }
        .nav-button {
            padding: 12px 25px; background: #3f51b5; color: white;
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 16px;
        }
        .teacher-info { 
            background: #3f51b5; color: white; padding: 15px; 
            text-align: center; margin-bottom: 20px;
        }
        .mark-5 { background: #4caf50; color: white; }
        .mark-4 { background: #8bc34a; color: white; }
        .mark-3 { background: #ffc107; }
        .mark-2 { background: #f44336; color: white; }
        .mark-N { background: #ff9800; color: white; }
        .mark-B { background: #2196f3; color: white; }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .month-navigation { text-align: center; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="teacher-info">
        <h2>Классный журнал</h2>
        <div id="teacherInfo">Загрузка...</div>
    </div>

    <div class="journal-page">
        <div class="class-navigation">
            <button class="nav-button" onclick="changeClass(-1)">← 7А</button>
            <div id="currentClass" class="class-header">7А класс</div>
            <button class="nav-button" onclick="changeClass(1)">7Б →</button>
        </div>

        <div class="month-navigation">
            <button class="nav-button" onclick="changeMonth(-1)">← Предыдущий месяц</button>
            <span id="monthRange">Ноябрь 2025</span>
            <button class="nav-button" onclick="changeMonth(1)">Следующий месяц →</button>
        </div>

        <table class="students-table">
            <thead id="tableHeader">
            </thead>
            <tbody id="studentsList">
            </tbody>
        </table>

        <div id="statusMessage"></div>

        <div style="margin-top: 20px; text-align: center;">
            <strong>Обозначения:</strong> 
            <span class="mark-cell mark-5">5</span>
            <span class="mark-cell mark-4">4</span> 
            <span class="mark-cell mark-3">3</span>
            <span class="mark-cell mark-2">2</span>
            <span class="mark-cell mark-N">Н</span>
            <span class="mark-cell mark-B">Б</span>
            <span style="margin-left: 20px;">Кликните по ячейке для выставления оценки</span>
        </div>
    </div>

    <script>
        const API_URL = 'https://d5dgr499nv8jsd5tf5id.y5sm01em.apigw.yandexcloud.net';
        const classes = ['7А', '7Б', '7В', '7Г'];
        let currentClassIndex = 0;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let teacherData = null;
        let allGrades = {};

        function loadJournal() {
            teacherData = JSON.parse(localStorage.getItem('user'));
            if (!teacherData) {
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('teacherInfo').textContent = 
                teacherData.full_name + ' • ' + teacherData.subject;
            loadClassData();
        }

        function loadClassData() {
            document.getElementById('currentClass').textContent = 
                classes[currentClassIndex] + ' класс';
            
            updateMonthRange();
            generateTableHeaders();
            loadAllStudentsGrades();
        }

        function generateTableHeaders() {
            const subjectDays = getSubjectDays(teacherData.subject, classes[currentClassIndex]);
            let headerHtml = '<th class="student-name">Ученик</th>';
            
            subjectDays.forEach(dayInfo => {
                headerHtml += `
                    <th class="date-header" data-date="${dayInfo.isoDate}">
                        ${dayInfo.dayName}<br>${dayInfo.dateStr}
                    </th>
                `;
            });
            
            document.getElementById('tableHeader').innerHTML = `<tr>${headerHtml}</tr>`;
        }

        function getSubjectDays(subject, className) {
            const schedule = getClassSchedule(className);
            const days = [];
            const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт'];
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            
            let currentDate = new Date(firstDay);
            
            while (currentDate <= lastDay) {
                const dayOfWeek = (currentDate.getDay() + 6) % 7;
                if (dayOfWeek < 5) {
                    const daySchedule = schedule[dayOfWeek];
                    if (daySchedule && daySchedule.includes(subject)) {
                        const year = currentDate.getFullYear();
                        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                        const day = String(currentDate.getDate()).padStart(2, '0');
                        const isoDate = `${year}-${month}-${day}`;
                        
                        const dateStr = formatDate(currentDate);
                        days.push({
                            isoDate: isoDate,
                            dateStr: dateStr,
                            dayName: dayNames[dayOfWeek]
                        });
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return days;
        }

        function loadAllStudentsGrades() {
            const students = getClassStudents(classes[currentClassIndex]);
            allGrades = {};
            
            if (students.length === 0) {
                showStatus('В этом классе нет учеников', 'error');
                renderStudentsTable(students);
                return;
            }
            
            const promises = students.map(student => 
                loadStudentGrades(student.id)
            );
            
            Promise.all(promises).then(() => {
                renderStudentsTable(students);
                showStatus('Данные загружены', 'success');
            }).catch(error => {
                console.error('Error loading grades:', error);
                showStatus('Ошибка загрузки оценок', 'error');
                renderStudentsTable(students);
            });
        }

        function loadStudentGrades(studentId) {
            return fetch(API_URL + '/grades?student_id=' + studentId)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.grades) {
                        allGrades[studentId] = {};
                        data.grades.forEach(grade => {
                            const key = `${grade.date}_${grade.subject}`;
                            allGrades[studentId][key] = grade.mark;
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading grades for student ' + studentId + ':', error);
                    allGrades[studentId] = {};
                });
        }

        function renderStudentsTable(students) {
            let studentsHtml = '';
            const currentSubject = teacherData.subject;
            const subjectDays = getSubjectDays(currentSubject, classes[currentClassIndex]);
            
            if (students.length === 0) {
                studentsHtml = `<tr><td colspan="${subjectDays.length + 1}" style="text-align: center; padding: 20px;">В этом классе нет учеников</td></tr>`;
            } else {
                students.forEach(student => {
                    let studentRow = `<td class="student-name">${student.name}</td>`;
                    const studentId = student.id;
                    const studentGrades = allGrades[studentId] || {};
                    
                    subjectDays.forEach(dayInfo => {
                        const gradeKey = `${dayInfo.isoDate}_${currentSubject}`;
                        const mark = studentGrades[gradeKey] || '';
                        
                        studentRow += `
                            <td class="mark-cell ${mark ? 'mark-' + mark : ''}" 
                                onclick="setMark(this, '${studentId}', '${dayInfo.isoDate}')"
                                data-student="${studentId}"
                                data-date="${dayInfo.isoDate}">
                                ${mark}
                            </td>
                        `;
                    });
                    
                    studentsHtml += `<tr>${studentRow}</tr>`;
                });
            }
            
            document.getElementById('studentsList').innerHTML = studentsHtml;
        }

        async function setMark(cell, studentId, dateStr) {
            const marks = ['', '5', '4', '3', '2', 'Н', 'Б'];
            const currentMark = cell.textContent.trim();
            let currentIndex = marks.indexOf(currentMark);
            if (currentIndex === -1) currentIndex = 0;
            const nextIndex = (currentIndex + 1) % marks.length;
            const newMark = marks[nextIndex];
            
            cell.classList.add('loading');
            cell.textContent = '';
            
            try {
                const [year, month, day] = dateStr.split('-').map(Number);
                const nextDay = new Date(year, month - 1, day + 1);
                const serverYear = nextDay.getFullYear();
                const serverMonth = String(nextDay.getMonth() + 1).padStart(2, '0');
                const serverDay = String(nextDay.getDate()).padStart(2, '0');
                const serverDate = `${serverYear}-${serverMonth}-${serverDay}`;
                
                const response = await fetch(API_URL + '/grades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        subject: teacherData.subject,
                        mark: newMark,
                        teacher_id: teacherData.id,
                        date: serverDate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const gradeKey = `${dateStr}_${teacherData.subject}`;
                    if (!allGrades[studentId]) {
                        allGrades[studentId] = {};
                    }
                    
                    if (newMark) {
                        allGrades[studentId][gradeKey] = newMark;
                    } else {
                        delete allGrades[studentId][gradeKey];
                    }
                    
                    cell.textContent = newMark;
                    cell.className = 'mark-cell';
                    if (newMark) {
                        cell.classList.add('mark-' + newMark);
                    }
                    
                    showStatus('Оценка сохранена', 'success');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error saving grade:', error);
                cell.textContent = currentMark;
                cell.className = 'mark-cell';
                if (currentMark) {
                    cell.classList.add('mark-' + currentMark);
                }
                showStatus('Ошибка сохранения оценки', 'error');
            } finally {
                cell.classList.remove('loading');
            }
        }

        function getClassStudents(className) {
            const students = {
                '7А': [
                    { name: 'Иванов Алексей', id: 'student1' },
                    { name: 'Петрова Мария', id: 'student2' },
                    { name: 'Сидоров Дмитрий', id: 'student3' },
                    { name: 'Козлова Анна', id: 'student4' }
                ],
                '7Б': [
                    { name: 'Николаев Иван', id: 'student5' },
                    { name: 'Смирнова Ольга', id: 'student6' },
                    { name: 'Васильев Петр', id: 'student7' },
                    { name: 'Орлова Елена', id: 'student8' }
                ],
                '7В': [
                    { name: 'Федоров Сергей', id: 'student9' },
                    { name: 'Павлова Ирина', id: 'student10' },
                    { name: 'Семенов Андрей', id: 'student11' },
                    { name: 'Михайлова Наталья', id: 'student12' }
                ],
                '7Г': [
                    { name: 'Алексеев Денис', id: 'student13' },
                    { name: 'Захарова Виктория', id: 'student14' },
                    { name: 'Романов Артем', id: 'student15' },
                    { name: 'Егорова Светлана', id: 'student16' }
                ]
            };
            return students[className] || [];
        }

        function getClassSchedule(className) {
    const schedules = {
        '7А': [
            ['Математика', 'Русский язык', 'Английский язык'],
            ['Физика', 'Биология', 'Математика'],
            ['Литература', 'Физкультура', 'Русский язык'],
            ['Химия', 'ОБЖ', 'История'],
            ['Информатика', 'Физкультура', 'Английский язык']
        ],
        '7Б': [
            ['Русский язык', 'Английский язык', 'Математика'],
            ['Биология', 'Математика', 'Физика'],
            ['Физкультура', 'Русский язык', 'Литература'],
            ['История', 'Химия', 'ОБЖ'],
            ['Английский язык', 'Информатика', 'Физкультура']
        ],
        '7В': [
            ['Английский язык', 'Математика', 'Русский язык'],
            ['Математика', 'Физика', 'Биология'],
            ['Русский язык', 'Литература', 'Физкультура'],
            ['ОБЖ', 'История', 'Химия'],
            ['Физкультура', 'Английский язык', 'Информатика']
        ],
        '7Г': [
            ['Математика', 'Физика', 'Биология'],
            ['Русский язык', 'Английский язык', 'Математика'],
            ['Физкультура', 'Русский язык', 'Литература'],
            ['Химия', 'ОБЖ', 'История'],
            ['Информатика', 'Физкультура', 'Английский язык']
        ]
    };
    return schedules[className] || [[],[],[],[],[]];
}

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        function changeClass(offset) {
            currentClassIndex = (currentClassIndex + offset + classes.length) % classes.length;
            loadClassData();
        }

        function changeMonth(offset) {
            currentMonth += offset;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            loadClassData();
        }

        function formatDate(date) {
            return date.getDate().toString().padStart(2, '0') + '.' + 
                   (date.getMonth()+1).toString().padStart(2, '0');
        }

        function updateMonthRange() {
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            document.getElementById('monthRange').textContent = 
                monthNames[currentMonth] + ' ' + currentYear;
        }

        loadJournal();
    </script>
</body>
</html>